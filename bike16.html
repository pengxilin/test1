<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…±äº«å•è½¦éª‘è¡ŒçŠ¶æ€ - ç¦å·</title>
    <script type="text/javascript" src="https://api.map.baidu.com/api?v=2.0&ak=YfGEslRFYjqQVQvAODYYsxCMXtypceT9"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 800px;
            margin: 20px auto;
            padding: 20px;
            background-color: #f0f2f5;
        }
        
        .container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            padding: 25px;
        }
        
        .status-card {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 25px;
        }
        
        .metric {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        
        .metric h3 {
            color: #666;
            margin: 0 0 8px 0;
            font-size: 14px;
        }
        
        .metric .value {
            font-size: 24px;
            font-weight: bold;
            color: #2d3436;
        }
        
        .unit {
            font-size: 12px;
            color: #888;
            margin-left: 2px;
        }
        
        #ride-map {
            height: 350px;
            border-radius: 8px;
            margin: 20px 0;
            border: 1px solid #ddd;
        }
        
        .controls {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        
        button {
            padding: 12px 25px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            margin: 5px;
        }
        
        #startBtn {
            background: #00b894;
            color: white;
        }
        
        #startBtn:disabled {
            background: #b2bec3;
            cursor: not-allowed;
        }
        
        #endBtn {
            background: #ff7675;
            color: white;
        }
        
        #historyBtn {
            background: #74b9ff;
            color: white;
        }
        
        #clearHistoryBtn {
            background: #fdcb6e;
            color: white;
        }
        
        .param-row {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            justify-content: center;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .param-row label {
            margin-right: 5px;
            font-weight: bold;
            font-size: 14px;
        }
        
        #speedBike {
            width: 60px;
            padding: 5px;
            border-radius: 4px;
            border: 1px solid #ddd;
        }
        
        .dark-mode {
            background-color: #1e1e2e !important;
            color: #f0f0f0 !important;
        }
        
        .dark-mode .container {
            background: #2d2d42 !important;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3) !important;
        }
        
        .dark-mode .metric {
            background: #3a3a5a !important;
        }
        
        .dark-mode .value {
            color: #ffffff !important;
        }
        .custom-alert {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 0 10px rgba(0,0,0,0.2);
        z-index: 1000;
        display: none;
    }
    .dark-mode .custom-alert {
        background: #3a3a5a;
        color: white;
    }
    </style>
</head>
<body>
    <div class="container">
        <div class="status-card">
            <div class="metric">
                <h3>éª‘è¡Œæ—¶é•¿</h3>
                <div><span id="duration" class="value">0</span><span class="unit">ç§’</span></div>
            </div>
            <div class="metric">
                <h3>è¡Œé©¶è·ç¦»</h3>
                <div><span id="distance" class="value">0.00</span><span class="unit">ç±³</span></div>
            </div>
            <div class="metric">
                <h3>å½“å‰é€Ÿåº¦</h3>
                <div><span id="speed" class="value">0.00</span><span class="unit">m/s</span></div>
            </div>
            <div class="metric">
                <h3>å®æ—¶ä½ç½®</h3>
                <div id="location" class="value">26.0745, 119.2964</div>
            </div>
        </div>
        <div class="custom-alert" id="customAlert">
            <div id="alertContent"></div>
            <button onclick="document.getElementById('customAlert').style.display='none'" 
                    style="margin-top:15px;padding:8px 16px;">
                ç¡®å®š
            </button>
        </div>
        <div id="ride-map"></div>

        <div class="param-row">
            <label><input id="follow" type="checkbox" checked> ç”»é¢è·Ÿéš</label>
            <span>ï¼š</span>
            <input type="number" id="speedBike" value="50" min="20" max="200" step="10">
            <select id="mapMode">
                <option value="normal">æ ‡å‡†æ¨¡å¼</option>
                <option value="satellite">å«æ˜Ÿæ¨¡å¼</option>
                <option value="traffic">è·¯å†µæ¨¡å¼</option>
            </select>
            <button id="toggleMapBtn">åˆ‡æ¢åœ°å›¾</button>
            <button id="toggleThemeBtn">åˆ‡æ¢ä¸»é¢˜</button>
        </div>

        <div class="controls">
            <button id="startBtn" onclick="startRide()">å¼€å§‹éª‘è¡Œ</button>
           
            <button id="endBtn" onclick="endRide()" disabled>ç»“æŸéª‘è¡Œ</button> 
            <button id="returnBtn" onclick="window.location.href =' https://pengxilin.github.io/test1/hello(4).html'">å‰å¾€è¿˜è½¦</button>      
            <button id="historyBtn" onclick="showRideHistory()" disabled>éª‘è¡Œå†å²</button>
            <button id="clearHistoryBtn" onclick="clearRideHistory()" disabled>æ¸…é™¤è®°å½•</button>
            <button id="exportBtn" onclick="exportRideData()" disabled>å¯¼å‡ºæ•°æ®</button>
        </div>
    </div>

    <script>
        // ç™¾åº¦åœ°å›¾ç›¸å…³å˜é‡
        let rideMap;
        let markerBaidu;
        let polylineBaidu;
        let pathCoordinates = [];
        
        let rideInterval;
        let startTime;
        // ç¦å·å¸‚ä¸­å¿ƒåæ ‡ï¼ˆä¸œè¡—å£é™„è¿‘ï¼‰
        let currentPosition = {
            lat: 26.0745,  
            lng: 119.2964
        };

        // éª‘è¡Œå†å²è®°å½•
        let rideHistory = [];
        let currentRideData = [];

        // æ–°å¢è‡ªå®šä¹‰å¼¹çª—åŠŸèƒ½
        function showAlert(message, isConfirm = false) {
            const alertBox = document.getElementById('customAlert');
            const contentDiv = document.getElementById('alertContent');
            
            // åŸºç¡€å†…å®¹
            contentDiv.innerHTML = message.replace(/\n/g, '<br>');
            
            // å¦‚æœæ˜¯ç¡®è®¤å¯¹è¯æ¡†
            if(isConfirm) {
                contentDiv.innerHTML += `
                    <div style="margin-top:20px;">
                        <button onclick="handleConfirm(true)" 
                                style="background:#00b894;color:white;">ç¡®å®š</button>
                        <button onclick="handleConfirm(false)" 
                                style="background:#ff7675;color:white;">å–æ¶ˆ</button>
                    </div>
                `;
            } else {
                contentDiv.innerHTML += `
                    <button onclick="document.getElementById('customAlert').style.display='none'" 
                            style="margin-top:15px;background:#74b9ff;">
                        ç¡®å®š
                    </button>
                `;
            }
            
            alertBox.style.display = 'block';
        }

        function handleConfirm(result) {
            document.getElementById('customAlert').style.display = 'none';
            if(result) {
                // æ‰§è¡Œç¡®è®¤æ“ä½œ
                rideHistory = [];
                updateButtonStates();
                showAlert('éª‘è¡Œè®°å½•å·²æ¸…é™¤');
            }
        }

        // æ¨¡æ‹Ÿéª‘è¡Œ
        function simulateRide() {
            const now = Date.now();
            const elapsed = (now - startTime) / 1000;
            // è·å–é€Ÿåº¦è®¾ç½®å€¼
            const speedSetting = parseInt(document.getElementById('speedBike').value) || 50;
            const baseSpeed = speedSetting / 20; // è½¬æ¢ä¸ºåˆé€‚çš„é€Ÿåº¦ç³»æ•°
            
            // è¿åŠ¨å‚æ•°è®¡ç®—
            const distance = elapsed * baseSpeed;
            const speed = baseSpeed + (Math.random() - 0.5);

            // æ›´æ–°ä½ç½®ï¼ˆæ¨¡æ‹Ÿåœ¨ç¦å·å¸‚åŒºç§»åŠ¨ï¼‰
            currentPosition.lat += (Math.random() - 0.5) * 0.0005;
            currentPosition.lng += (Math.random() - 0.3) * 0.0005;

            // æ›´æ–°åœ°å›¾
            try {
                const newPoint = new BMap.Point(currentPosition.lng, currentPosition.lat);
                markerBaidu.setPosition(newPoint);
                pathCoordinates.push(newPoint);
                
                // æ›´æ–°è·¯å¾„
                polylineBaidu.setPath(pathCoordinates);
                
                // å¦‚æœå¼€å¯ç”»é¢è·Ÿéš
                if(document.getElementById('follow').checked) {
                    rideMap.setCenter(newPoint);
                }
            } catch (e) {
                console.error('åœ°å›¾æ›´æ–°å¼‚å¸¸:', e);
            }

            updateDisplay(elapsed, distance, speed);
            
            // è®°å½•æœ¬æ¬¡éª‘è¡Œæ•°æ®
            currentRideData.push({
                time: elapsed,
                speed: speed
            });
        }

        function updateDisplay(duration, distance, speed) {
            document.getElementById('duration').textContent = Math.floor(duration);
            document.getElementById('distance').textContent = distance.toFixed(2);
            document.getElementById('speed').textContent = speed.toFixed(2);
            document.getElementById('location').textContent = 
                `${currentPosition.lat.toFixed(4)}, ${currentPosition.lng.toFixed(4)}`;
        }

        function startRide() {
            // é‡ç½®æ‰€æœ‰çŠ¶æ€
            clearInterval(rideInterval);
            pathCoordinates = [];
            currentRideData = [];
            startTime = Date.now();
            // é‡ç½®ä¸ºç¦å·åˆå§‹ä½ç½®
            currentPosition = { lat: 26.0745, lng: 119.2964 };
            
            // åˆå§‹åŒ–éª‘è¡Œåœ°å›¾
            rideMap = new BMap.Map("ride-map");
            rideMap.centerAndZoom(new BMap.Point(currentPosition.lng, currentPosition.lat), 16);
            rideMap.enableScrollWheelZoom();
            rideMap.addControl(new BMap.NavigationControl());
            
            // è®¾ç½®åœ°å›¾æ¨¡å¼
            const mapMode = document.getElementById('mapMode').value;
            setMapMode(mapMode);
            
            // ä¿®æ”¹å›¾æ ‡URLä¸ºå¯é çš„çŸ¢é‡å›¾é“¾æ¥
            const bikeIcon = new BMap.Icon(
                'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1MTIgNTEyIj48cGF0aCBkPSJNMjU2IDBDMTE0LjYgMCAwIDExNC42IDAgMjU2czExNC42IDI1NiAyNTYgMjU2IDI1Ni0xMTQuNiAyNTYtMjU2UzM5Ny40IDAgMjU2IDB6bS0zMiAzNjguOEwxNDQgMjg4bDMyLTMyaDk2bC00OCA2NGg0OGwtMzIgNDh6bTk2LTEyLjhsLTMuMi00LjggMTIuOC0xNiA0OCA2NC0yNCAzMi0xNi0xNnptMTI4LTE5LjJsLTE5LjItMjguOCA0OC02NCAyNCAzMi0xNiAxNnptLTY0LTEyOGwtMzItNDggNDgtNjQgMzIgNDh6bTk2IDk2bC0zMi00OCA0OC02NCAzMiA0OHoiIGZpbGw9IiMwMDdiZmYiLz48L3N2Zz4=',
                new BMap.Size(15, 15), 
                { anchor: new BMap.Size(18, 36) }
            );
            markerBaidu = new BMap.Marker(
                new BMap.Point(currentPosition.lng, currentPosition.lat), 
                { icon: bikeIcon }
            );
            rideMap.addOverlay(markerBaidu);

            // åˆå§‹åŒ–è½¨è¿¹çº¿
            polylineBaidu = new BMap.Polyline([], {
                strokeColor: "#00b894",
                strokeWeight: 4,
                strokeOpacity: 0.8
            });
            rideMap.addOverlay(polylineBaidu);

            // ç«‹å³æ›´æ–°åˆå§‹çŠ¶æ€
            updateDisplay(0, 0, 0);
            
            // å¯åŠ¨å®šæ—¶å™¨
            document.getElementById('startBtn').disabled = true;
            document.getElementById('endBtn').disabled = false;
            document.getElementById('historyBtn').disabled = true;
            document.getElementById('clearHistoryBtn').disabled = true;
            document.getElementById('exportBtn').disabled = true;
            rideInterval = setInterval(simulateRide, 1000);
      
        }

        // æ·»åŠ ç¦å·å¸‚åŒºåœ°æ ‡
        function addFuzhouLandmarks() {
            const landmarks = [
                {name: "ä¸œè¡—å£", point: new BMap.Point(119.2964, 26.0745)},
                {name: "ä¸‰åŠä¸ƒå··", point: new BMap.Point(119.2912, 26.0817)},
                {name: "ç¦å·ç«™", point: new BMap.Point(119.3065, 26.1089)},
                {name: "äº”ä¸€å¹¿åœº", point: new BMap.Point(119.2992, 26.0718)},
                {name: "ç¦å·å¤§å­¦", point: new BMap.Point(119.1874, 26.0613)}
            ];
            
            landmarks.forEach(landmark => {
                const marker = new BMap.Marker(landmark.point);
                const label = new BMap.Label(landmark.name, {
                    offset: new BMap.Size(15, -10)
                });
                marker.setLabel(label);
                rideMap.addOverlay(marker);
            });
        }

        function endRide() {
            clearInterval(rideInterval);
            document.getElementById('startBtn').disabled = false;
            document.getElementById('endBtn').disabled = true;
            document.getElementById('historyBtn').disabled = false;
            document.getElementById('clearHistoryBtn').disabled = false;
            document.getElementById('exportBtn').disabled = false;
            
            const finalDuration = (Date.now() - startTime) / 1000;
            const finalDistance = parseFloat(document.getElementById('distance').textContent);
            
            // è®°å½•éª‘è¡Œå†å²
            rideHistory.push({
                duration: finalDuration,
                distance: finalDistance,
                timestamp: new Date().toLocaleString()
            });
            
            alert(`éª‘è¡Œç»“æŸï¼\næ—¶é•¿ï¼š${finalDuration.toFixed(1)}ç§’\nè·ç¦»ï¼š${finalDistance}ç±³`);
        }

        // æ˜¾ç¤ºéª‘è¡Œå†å²
        function showRideHistory() {
            if (rideHistory.length === 0) {
                showAlert('æš‚æ— éª‘è¡Œè®°å½•');
                return;
            }
            
            let historyHtml = `<div style="text-align:left;">
                <h3 style="margin-bottom:15px;">éª‘è¡Œå†å²ï¼ˆå…±${rideHistory.length}æ¡ï¼‰</h3>`;
            
            rideHistory.forEach((ride, index) => {
                historyHtml += `
                    <div style="margin-bottom:15px;padding:10px;background:#f8f9fa;border-radius:8px;">
                        <div>ğŸš´ ç¬¬${index + 1}æ¬¡éª‘è¡Œ</div>
                        <div>â±ï¸ ${ride.timestamp}</div>
                        <div>â³ æ—¶é•¿ï¼š${ride.duration.toFixed(1)}ç§’</div>
                        <div>ğŸ“ è·ç¦»ï¼š${ride.distance.toFixed(2)}ç±³</div>
                    </div>
                `;
            });
            
            historyHtml += `</div>`;
            showAlert(historyHtml);
        }

        // æ¸…é™¤éª‘è¡Œå†å²
        function clearRideHistory() {
            if (rideHistory.length === 0) {
                showAlert('æš‚æ— éª‘è¡Œè®°å½•å¯æ¸…é™¤');
                return;
            }
            
            showAlert(
                `<div style="font-size:16px;margin-bottom:15px;">
                    â— ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰éª‘è¡Œè®°å½•å—ï¼Ÿ
                </div>
                <div style="color:#888;font-size:14px;">
                    ï¼ˆå…±${rideHistory.length}æ¡è®°å½•å°†è¢«æ°¸ä¹…åˆ é™¤ï¼‰
                </div>`,
                true // æ ‡è®°ä¸ºç¡®è®¤å¯¹è¯æ¡†
            );
        }

        function updateButtonStates() {
            const hasHistory = rideHistory.length > 0;
            document.getElementById('historyBtn').disabled = !hasHistory;
            document.getElementById('clearHistoryBtn').disabled = !hasHistory;
            document.getElementById('exportBtn').disabled = !hasHistory;
        }

        // å¯¼å‡ºéª‘è¡Œæ•°æ®
        function exportRideData() {
            if (rideHistory.length === 0) {
                alert('æš‚æ— éª‘è¡Œè®°å½•å¯å¯¼å‡º');
                return;
            }
            
            const dataStr = JSON.stringify(rideHistory, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            a.download = 'ride_history.json';
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
        }

        // åˆ‡æ¢åœ°å›¾æ¨¡å¼
        function toggleMap() {
            const mapElement = document.getElementById('ride-map');
            if (mapElement.style.height === '600px') {
                mapElement.style.height = '350px';
            } else {
                mapElement.style.height = '600px';
            }
        }

        // åˆ‡æ¢ä¸»é¢˜
        function toggleTheme() {
            document.body.classList.toggle('dark-mode');
        }

        // è®¾ç½®åœ°å›¾æ¨¡å¼
        function setMapMode(mode) {
            switch(mode) {
                case 'normal':
                    rideMap.setMapType(BMAP_NORMAL_MAP);
                    break;
                case 'satellite':
                    rideMap.setMapType(BMAP_SATELLITE_MAP);
                    break;
                case 'traffic':
                    rideMap.setMapType(BMAP_TRAFFIC_MAP);
                    break;
            }
        }

        // åˆå§‹åŒ–åœ°å›¾
        window.onload = function() {
            rideMap = new BMap.Map("ride-map");
            rideMap.centerAndZoom(new BMap.Point(119.2964, 26.0745), 14);
            rideMap.enableScrollWheelZoom();
            rideMap.addControl(new BMap.NavigationControl());
            addFuzhouLandmarks();
            updateDisplay(0, 0, 0);
            
            // åˆå§‹åŒ–æŒ‰é’®çŠ¶æ€
            document.getElementById('startBtn').disabled = false;
            document.getElementById('endBtn').disabled = true;
            document.getElementById('historyBtn').disabled = true;
            document.getElementById('clearHistoryBtn').disabled = true;
            document.getElementById('exportBtn').disabled = true;
            
            // åˆå§‹åŒ–åœ°å›¾æ¨¡å¼é€‰æ‹©å™¨
            document.getElementById('mapMode').addEventListener('change', function() {
                if (rideMap) {
                    setMapMode(this.value);
                }
            });
            
            // åˆå§‹åŒ–åœ°å›¾åˆ‡æ¢æŒ‰é’®
            document.getElementById('toggleMapBtn').addEventListener('click', toggleMap);
            
            // åˆå§‹åŒ–ä¸»é¢˜åˆ‡æ¢æŒ‰é’®
            document.getElementById('toggleThemeBtn').addEventListener('click', toggleTheme);
        };
        function returnBike() {
    if (rideInterval) {
        clearInterval(rideInterval);
        document.getElementById('startBtn').disabled = false;
        document.getElementById('endBtn').disabled = true;
        
        const finalDuration = (Date.now() - startTime) / 1000;
        const finalDistance = parseFloat(document.getElementById('distance').textContent);
        
        rideHistory.push({
            duration: finalDuration,
            distance: finalDistance,
            timestamp: new Date().toLocaleString()
        });
    } else {
        // å¦‚æœæ²¡æœ‰éª‘è¡Œï¼Œåˆ™è®°å½•ä¸€ä¸ªè¿˜è½¦ç‚¹
        rideHistory.push({
            duration: 0,
            distance: 0,
            timestamp: new Date().toLocaleString()
        });
    }
    
    alert(`æ‚¨å·²è¿˜è½¦ï¼`);
    updateButtonStates();
    resetRideDisplay();
}

function endRide() {
    if (!rideInterval) {
        alert('å½“å‰æœªå¤„äºéª‘è¡ŒçŠ¶æ€ï¼Œè¯·å…ˆå¼€å§‹éª‘è¡Œ');
        return;
    }
    clearInterval(rideInterval);
    document.getElementById('startBtn').disabled = false;
    document.getElementById('endBtn').disabled = true;
    
    const finalDuration = (Date.now() - startTime) / 1000;
    const finalDistance = parseFloat(document.getElementById('distance').textContent);
    
    rideHistory.push({
        duration: finalDuration,
        distance: finalDistance,
        timestamp: new Date().toLocaleString()
    });
    
    alert(`éª‘è¡Œç»“æŸï¼\næ—¶é•¿ï¼š${finalDuration.toFixed(1)}ç§’\nè·ç¦»ï¼š${finalDistance}ç±³`);
    updateButtonStates();
    resetRideDisplay();
}

function resetRideDisplay() {
    updateDisplay(0, 0, 0);
    currentPosition = { lat: 26.0745, lng: 119.2964 };
    markerBaidu.setPosition(new BMap.Point(currentPosition.lng, currentPosition.lat));
    pathCoordinates = [];
    polylineBaidu.setPath(pathCoordinates);
    
    // è§£å†³é—®é¢˜çš„å…³é”®ï¼šåœ¨éª‘è¡Œç»“æŸåï¼Œä»ç„¶ä¿æŒâ€œå‰å¾€è¿˜è½¦â€æŒ‰é’®å¯ç”¨
    document.getElementById('returnBtn').disabled = false;
}

function updateButtonStates() {
    const hasHistory = rideHistory.length > 0;
    document.getElementById('historyBtn').disabled = !hasHistory;
    document.getElementById('clearHistoryBtn').disabled = !hasHistory;
    document.getElementById('exportBtn').disabled = !hasHistory;
    
    // å§‹ç»ˆä¿æŒâ€œå‰å¾€è¿˜è½¦â€æŒ‰é’®å¯ç”¨
    document.getElementById('returnBtn').disabled = false;
}
    </script>
</body>
</html>
